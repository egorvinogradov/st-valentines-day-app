// Generated by CoffeeScript 1.6.3
var getPhotoByEmail;

getPhotoByEmail = function(email, callback) {
  var getGooglePhoto;
  getGooglePhoto = function(gCallback) {
    return $.ajax({
      url: "http://plus.google.com/complete/search",
      dataType: "jsonp",
      timeout: 5000,
      data: {
        client: "es-people-picker",
        q: email
      },
      success: function(googleData) {
        var _ref, _ref1, _ref2;
        if (googleData != null ? (_ref = googleData[1]) != null ? (_ref1 = _ref[0]) != null ? (_ref2 = _ref1[3]) != null ? _ref2.b : void 0 : void 0 : void 0 : void 0) {
          return gCallback(googleData[1][0][3].b);
        } else {
          return gCallback("");
        }
      },
      error: function() {
        return gCallback("");
      }
    });
  };
  return $.ajax({
    url: "http://gravatar.com/" + (md5(email)) + ".json",
    dataType: "jsonp",
    timeout: 5000,
    success: function(data) {
      var facebook, facebookId, facebookPhoto, facebookUsername, gravatarPhoto, gravatarProfile, _ref, _ref1, _ref2, _ref3,
        _this = this;
      if (data != null ? (_ref = data.entry) != null ? _ref[0] : void 0 : void 0) {
        gravatarProfile = data.entry[0];
        gravatarPhoto = (_ref1 = gravatarProfile.photos) != null ? (_ref2 = _ref1[0]) != null ? _ref2.value : void 0 : void 0;
        if (gravatarPhoto) {
          gravatarPhoto = gravatarPhoto += "?s=200";
        }
        if ((_ref3 = gravatarProfile.accounts) != null ? _ref3.length : void 0) {
          facebook = _.find(gravatarProfile.accounts, function(account) {
            return account.domain === "facebook.com";
          });
          if (facebook.url) {
            if (/profile\.php/.test(facebook.url)) {
              facebookId = facebook.url.split("profile.php?id=")[1];
            } else {
              facebookUsername = facebook.url.split(".com/")[1];
            }
            facebookPhoto = "http://graph.facebook.com/" + (facebookId || facebookUsername) + "/picture?type=large";
            return callback(facebookPhoto);
          } else {
            return callback(gravatarPhoto);
          }
        }
      } else {
        return getGooglePhoto(callback);
      }
    },
    error: function() {
      return getGooglePhoto(callback);
    }
  });
};
